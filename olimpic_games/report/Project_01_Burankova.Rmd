---
title: "Project â„–1 Burankova"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Import and data checking

## Import required library
**tidyverse** library is used for processing data.\

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

This library include all required libraries:\
- **ggplot2**, for data visualization.\
- **dplyr**, for data manipulation.\
- **tidyr**, for data tidying.\
- **readr**, for data import.\
- **purrr**, for functional programming.\

## Import .csv data
For import all .csv file to one list, run:
```{r message=FALSE, warning=FALSE}
all_participants <-
  list.files(path = "../data/", pattern = "*.csv", full.names = TRUE) %>% 
  map_df(~read_csv(.))
```
.csv files with raw data should be placed in /data/ folder.\
The data:
```{r echo=FALSE}
head(all_participants)
```


## Check and fix the data

For each column, we check for wrong values:\
- if we know the missing value for the participant (by ID) from other rows from the same year - we change it.\
- if we don`t know anything - change to NA.\
We do not delete any records, even if they contain only information about the participant ID about which there are more complete records. Removing such "truncated" rows would distort information like "the number of participation at the each Olympiad for each participant".\
Thus, we will save the maximum information about each of the participants.


### "Sex" column
Check "Sex" column.
```{r echo=FALSE}
all_participants %>% filter(!(Sex %in% c('F', 'M', NA)))

```

Fix wrong values to correct (if known - for ID == '79609') or to NA:
```{r}
#Check if we know something about the participants:
all_participants %>% filter(ID == '79609' | ID == '79630')

all_participants <- all_participants %>% mutate(Sex = ifelse(ID == '79609', 'M', Sex))
all_participants <- all_participants %>% 
  mutate(Sex = ifelse(!Sex %in% c('F', 'M', NA), 'NA', Sex))
```

### "Sport" column

```{r echo=FALSE}
all_participants %>% group_by(Sport) %>% summarise()
```

After reviewing the data manually, there find some problems with "football":

```{r echo=FALSE}
all_participants %>% filter(str_detect(Sport, "Footba")) %>% group_by(Sport) %>% 
  summarise()
```
Change 'footba' to football:
```{r}
all_participants <- all_participants %>% 
  mutate(Sport = ifelse(Sport == "Footba", 'Football', Sport))
```

### "Name" column
Let's check the correctness of the participants names.\
Each participant is assigned an ID. The ID is assigned sequentially, one participant for each ID.\
The number of participants names have to match the number of IDs.

```{r message=FALSE, warning=FALSE, include=FALSE}
ID <- all_participants %>% group_by(ID, Name) %>% summarise() %>% ungroup() %>% 
  mutate(RowNumber = 1:n()) %>% tail(1)
```
Do we have duplicate participants and how many are there: \
- 'true' if there are no duplicates: **`r ID[3] - ID[1] == 0`**.\
- how many duplicates: **`r (ID[3] - ID[1])[1,1]`**.\

In this case only one participant register twice.\
Find the participant registered twice under different names: ID - `r format(all_participants %>% group_by(ID, Name) %>% summarise() %>% ungroup() %>% mutate(RowNumber = 1:n()) %>% filter(RowNumber != ID) %>% head(1)[1,1], scientific = FALSE)`.

```{r echo=FALSE, message=FALSE, warning=FALSE}

wrong_ID <- (all_participants %>% 
               group_by(ID, Name) %>%
               summarise() %>% 
               ungroup() %>% 
               mutate(RowNumber = 1:n()) %>%
               filter(RowNumber != ID) %>%  
               head(1)[1,1])


all_participants %>% filter(ID == wrong_ID)

```

Let's fix it:

```{r}

all_participants <- all_participants %>% 
  mutate(Name = ifelse((Name == 'Pietro Spec' & ID == '113716'), 'Pietro Speciale', Name))

```

If we have a lot of wrong names and it is impossible to manually fix it by setting the correct name - assign the names to constant number.\
But in this case, we lose information about names for duplicate participants. Therefore, one should manually change the names whenever possible.

```{r message=FALSE, warning=FALSE}

f_names <- function(all_participants) {
  all_participants %>% group_by(ID, Name) %>% summarise() %>% ungroup() %>% 
    mutate(RowNumber = 1:n()) %>% filter(RowNumber != ID) %>% head(1)[1,1,1]
}

for (i in c(1:(ID[3] - ID[1])[1,1])){
  all_participants <- all_participants %>% 
    mutate(Name = ifelse((ID == f_names(all_participants)), toString(i), Name))
}

```


### "Height" column
The tallest person in the world was 272 cm tall. Let's check our data:
```{r echo=FALSE}
all_participants %>% filter(ID %in% (all_participants %>% 
                                     filter(Height > 272) %>%  
                                     .[,1,1]) &
                            Age %in% (all_participants %>% 
                                      filter(Height > 272) %>%  
                                      .[,4,1]))

```

As can be seen from data, the participant #23549 is 176 cm tall. Let's fix it:
```{r}
all_participants <- all_participants %>% 
  mutate(Height = ifelse((ID == '23549' & Height > 272), 176, Height))
```


If it is impossible to manually fix it - assign the height to NA:
```{r}

all_participants <- all_participants %>% 
  mutate(Height = ifelse(Height > 272, NA, Height))

```


### 'Age' column
The oldest person in the world died aged 122.
```{r echo=FALSE}
all_participants %>% filter(ID %in% (all_participants %>% 
                                    filter(Age > 122) %>%  
                                    .[,1,1]) &
                            Year %in% (all_participants %>% 
                                      filter(Age > 122) %>%  
                                      .[,10,1]))
```
In 1912 he was 24. Fix:
```{r}
all_participants <- all_participants %>% 
  mutate(Age = ifelse((ID == '23459' & Age == 240), 24, Age))
```

If it is impossible to manually fix it - assign the age to NA:
```{r}
all_participants <- all_participants %>% 
  mutate(Age = ifelse(Age > 122, NA, Age))
```

The youngest participant in the Games was about 8 years old - it is a record.\
Let's check if there are younger members in the data. If the record was not broken - replace incorrect value manually or to NA

```{r echo=FALSE}
all_participants %>% filter(ID %in% (all_participants %>% 
                                    filter(Age < 8) %>%  
                                    .[,1,1]) &
                            Year %in% (all_participants %>% 
                                      filter(Age < 8) %>%  
                                      .[,10,1]))
```


### 'Weight' column
According to WHO, for a person 8 years old, a weight of 17 kg is considered very low. Let's check if we have participants with extremely low weight. 

```{r echo=FALSE}
all_participants %>% filter(ID %in% (all_participants %>% 
                                     filter(Weight < 17) %>%  
                                     .[,1,1]))
```
At 25 he was 77 kg. Fix:
```{r}
all_participants <- all_participants %>% 
  mutate(Weight = ifelse((ID == '68370' & Weight == 7), 77, Weight))
```

If it is impossible to manually fix it - assign the age to NA:
```{r}
all_participants <- all_participants %>% 
  mutate(Weight = ifelse(Weight < 17, NA, Weight))
```

The fattest man in the world weighed 445 kg. Let's check our data.\
If the record was not broken - replace incorrect value manually or to NA.
```{r echo=FALSE}
all_participants %>% filter(ID %in% (all_participants %>% 
                                     filter(Weight > 445) %>%  
                                     .[,1,1]))
```

```{r}
all_participants <- all_participants %>% 
  mutate(Weight = ifelse(Weight > 445, NA, Weight))
```


### 'Games' column
We will find problems in seasons naming:

```{r echo=FALSE}
all_participants %>% 
  filter(!(grepl('Summer', Games, fixed = TRUE) | 
         grepl('Winter', Games, fixed = TRUE) |
         is.na(Games)))
```

Fix it:
```{r}
all_participants <- all_participants %>% 
  mutate(Games=sub('S+.*$', 'Summer', Games)) %>% 
  mutate(Games=sub('W+.*$', 'Winter', Games))
```


### 'Year' column
If we know the Game, we also know the year of its holding.\
Let's fix the empty values.

```{r}
all_participants <- all_participants %>% 
  mutate(Year = ifelse((is.na(Year) & !is.na(Games)), 
                       str_extract(Games,'^[[:digit:]]{4}'), 
                       Year))
```

### 'Season' column
If we know the Game, we also know the Season of its holding.\
Let's fix the empty values.

```{r}
all_participants <- all_participants %>% 
  mutate(Season = ifelse((is.na(Season) & !is.na(Games)),
                         str_extract(Games,'[[:alpha:]]+$'), 
                         Season))
```


### Others columns
All is OK:

```{r echo=TRUE}
all_participants %>% filter(!(Medal %in% c('Gold', 'Silver', 'Bronze', NA)))

```

```{r include=TRUE, echo=FALSE}
all_participants %>% group_by(City) %>%  summarise()

all_participants %>% group_by(Event) %>%  summarise() 


```

# Olympic statistics

## Youngest at the 1992 Olympics

```{r include=FALSE}
youngest_men_1992 <- all_participants %>% filter(Year == 1992 & Sex == 'M') %>% 
  filter(Age == min(Age, na.rm = TRUE))

youngest_woman_1992 <- all_participants %>% filter(Year == 1992 & Sex == 'F') %>% 
  filter(Age == min(Age, na.rm = TRUE)) 
```

Age of the youngest athletes at the 1992 Olympics is **`r youngest_men_1992[1,4,1]`** years for men, and **`r youngest_woman_1992[1,4,1]`** years for women.

## Mean and sd of Height variable 
```{r include=FALSE}
mean_man <- all_participants %>% filter(Sex == 'M') %>% 
  summarise(mean(Height, na.rm = TRUE))
mean_woman <- all_participants %>% filter(Sex == 'F') %>% 
  summarise(mean(Height, na.rm = TRUE))

sd_woman <- all_participants %>% filter(Sex == 'F') %>% 
  summarise(sd(Height, na.rm = TRUE))
sd_man <- all_participants %>% filter(Sex == 'M') %>% 
  summarise(sd(Height, na.rm = TRUE))

```

For men Height variable has **mean = `r round(mean_man[1,1,1], 2)`** and **standard deviation = `r round(sd_man[1,1,1], 2)`**

For women Height variable has **mean = `r round(mean_woman[1,1,1], 2)`** and **standard deviation = `r round(sd_woman[1,1,1], 2)`**

## 